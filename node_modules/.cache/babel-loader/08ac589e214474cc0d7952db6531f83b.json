{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Util_1 = require(\"./Util\");\n\nvar Factory_1 = require(\"./Factory\");\n\nvar Container_1 = require(\"./Container\");\n\nvar Global_1 = require(\"./Global\");\n\nvar Canvas_1 = require(\"./Canvas\");\n\nvar DragAndDrop_1 = require(\"./DragAndDrop\");\n\nvar Global_2 = require(\"./Global\");\n\nvar STAGE = 'Stage',\n    STRING = 'string',\n    PX = 'px',\n    MOUSEOUT = 'mouseout',\n    MOUSELEAVE = 'mouseleave',\n    MOUSEOVER = 'mouseover',\n    MOUSEENTER = 'mouseenter',\n    MOUSEMOVE = 'mousemove',\n    MOUSEDOWN = 'mousedown',\n    MOUSEUP = 'mouseup',\n    CONTEXTMENU = 'contextmenu',\n    CLICK = 'click',\n    DBL_CLICK = 'dblclick',\n    TOUCHSTART = 'touchstart',\n    TOUCHEND = 'touchend',\n    TAP = 'tap',\n    DBL_TAP = 'dbltap',\n    TOUCHMOVE = 'touchmove',\n    WHEEL = 'wheel',\n    CONTENT_MOUSEOUT = 'contentMouseout',\n    CONTENT_MOUSEOVER = 'contentMouseover',\n    CONTENT_MOUSEMOVE = 'contentMousemove',\n    CONTENT_MOUSEDOWN = 'contentMousedown',\n    CONTENT_MOUSEUP = 'contentMouseup',\n    CONTENT_CONTEXTMENU = 'contentContextmenu',\n    CONTENT_CLICK = 'contentClick',\n    CONTENT_DBL_CLICK = 'contentDblclick',\n    CONTENT_TOUCHSTART = 'contentTouchstart',\n    CONTENT_TOUCHEND = 'contentTouchend',\n    CONTENT_DBL_TAP = 'contentDbltap',\n    CONTENT_TAP = 'contentTap',\n    CONTENT_TOUCHMOVE = 'contentTouchmove',\n    CONTENT_WHEEL = 'contentWheel',\n    RELATIVE = 'relative',\n    KONVA_CONTENT = 'konvajs-content',\n    SPACE = ' ',\n    UNDERSCORE = '_',\n    CONTAINER = 'container',\n    MAX_LAYERS_NUMBER = 5,\n    EMPTY_STRING = '',\n    EVENTS = [MOUSEENTER, MOUSEDOWN, MOUSEMOVE, MOUSEUP, MOUSEOUT, TOUCHSTART, TOUCHMOVE, TOUCHEND, MOUSEOVER, WHEEL, CONTEXTMENU],\n    eventsLength = EVENTS.length;\n\nfunction addEvent(ctx, eventName) {\n  ctx.content.addEventListener(eventName, function (evt) {\n    ctx[UNDERSCORE + eventName](evt);\n  }, false);\n}\n\nvar NO_POINTERS_MESSAGE = \"Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);\";\nexports.stages = [];\n\nfunction checkNoClip(attrs) {\n  if (attrs === void 0) {\n    attrs = {};\n  }\n\n  if (attrs.clipFunc || attrs.clipWidth || attrs.clipHeight) {\n    Util_1.Util.warn('Stage does not support clipping. Please use clip for Layers or Groups.');\n  }\n\n  return attrs;\n}\n\nvar Stage = function (_super) {\n  __extends(Stage, _super);\n\n  function Stage(config) {\n    var _this = _super.call(this, checkNoClip(config)) || this;\n\n    _this._buildDOM();\n\n    _this._bindContentEvents();\n\n    exports.stages.push(_this);\n\n    _this.on('widthChange.konva heightChange.konva', _this._resizeDOM);\n\n    _this.on('visibleChange.konva', _this._checkVisibility);\n\n    _this.on('clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva', function () {\n      checkNoClip(_this.attrs);\n    });\n\n    _this._checkVisibility();\n\n    return _this;\n  }\n\n  Stage.prototype._validateAdd = function (child) {\n    var isLayer = child.getType() === 'Layer';\n    var isFastLayer = child.getType() === 'FastLayer';\n    var valid = isLayer || isFastLayer;\n\n    if (!valid) {\n      Util_1.Util.throw('You may only add layers to the stage.');\n    }\n  };\n\n  Stage.prototype._checkVisibility = function () {\n    var style = this.visible() ? '' : 'none';\n    this.content.style.display = style;\n  };\n\n  Stage.prototype.setContainer = function (container) {\n    if (typeof container === STRING) {\n      if (container.charAt(0) === '.') {\n        var className = container.slice(1);\n        container = document.getElementsByClassName(className)[0];\n      } else {\n        var id;\n\n        if (container.charAt(0) !== '#') {\n          id = container;\n        } else {\n          id = container.slice(1);\n        }\n\n        container = document.getElementById(id);\n      }\n\n      if (!container) {\n        throw 'Can not find container in document with id ' + id;\n      }\n    }\n\n    this._setAttr(CONTAINER, container);\n\n    if (this.content) {\n      this.content.parentElement.removeChild(this.content);\n      container.appendChild(this.content);\n    }\n\n    return this;\n  };\n\n  Stage.prototype.shouldDrawHit = function () {\n    return true;\n  };\n\n  Stage.prototype.clear = function () {\n    var layers = this.children,\n        len = layers.length,\n        n;\n\n    for (n = 0; n < len; n++) {\n      layers[n].clear();\n    }\n\n    return this;\n  };\n\n  Stage.prototype.clone = function (obj) {\n    if (!obj) {\n      obj = {};\n    }\n\n    obj.container = document.createElement('div');\n    return Container_1.Container.prototype.clone.call(this, obj);\n  };\n\n  Stage.prototype.destroy = function () {\n    _super.prototype.destroy.call(this);\n\n    var content = this.content;\n\n    if (content && Util_1.Util._isInDocument(content)) {\n      this.container().removeChild(content);\n    }\n\n    var index = exports.stages.indexOf(this);\n\n    if (index > -1) {\n      exports.stages.splice(index, 1);\n    }\n\n    return this;\n  };\n\n  Stage.prototype.getPointerPosition = function () {\n    if (!this.pointerPos) {\n      Util_1.Util.warn(NO_POINTERS_MESSAGE);\n    }\n\n    return this.pointerPos;\n  };\n\n  Stage.prototype.getStage = function () {\n    return this;\n  };\n\n  Stage.prototype.getContent = function () {\n    return this.content;\n  };\n\n  Stage.prototype._toKonvaCanvas = function (config) {\n    config = config || {};\n\n    var x = config.x || 0,\n        y = config.y || 0,\n        canvas = new Canvas_1.SceneCanvas({\n      width: config.width || this.width(),\n      height: config.height || this.height(),\n      pixelRatio: config.pixelRatio || 1\n    }),\n        _context = canvas.getContext()._context,\n        layers = this.children;\n\n    if (x || y) {\n      _context.translate(-1 * x, -1 * y);\n    }\n\n    layers.each(function (layer) {\n      if (!layer.isVisible()) {\n        return;\n      }\n\n      var layerCanvas = layer._toKonvaCanvas(config);\n\n      _context.drawImage(layerCanvas._canvas, x, y, layerCanvas.getWidth() / layerCanvas.getPixelRatio(), layerCanvas.getHeight() / layerCanvas.getPixelRatio());\n    });\n    return canvas;\n  };\n\n  Stage.prototype.getIntersection = function (pos, selector) {\n    var layers = this.children,\n        len = layers.length,\n        end = len - 1,\n        n,\n        shape;\n\n    for (n = end; n >= 0; n--) {\n      shape = layers[n].getIntersection(pos, selector);\n\n      if (shape) {\n        return shape;\n      }\n    }\n\n    return null;\n  };\n\n  Stage.prototype._resizeDOM = function () {\n    if (this.content) {\n      var width = this.width(),\n          height = this.height(),\n          layers = this.getChildren(),\n          len = layers.length,\n          n,\n          layer;\n      this.content.style.width = width + PX;\n      this.content.style.height = height + PX;\n      this.bufferCanvas.setSize(width, height);\n      this.bufferHitCanvas.setSize(width, height);\n\n      for (n = 0; n < len; n++) {\n        layer = layers[n];\n        layer.setSize({\n          width: width,\n          height: height\n        });\n        layer.draw();\n      }\n    }\n  };\n\n  Stage.prototype.add = function (layer) {\n    if (arguments.length > 1) {\n      for (var i = 0; i < arguments.length; i++) {\n        this.add(arguments[i]);\n      }\n\n      return this;\n    }\n\n    _super.prototype.add.call(this, layer);\n\n    var length = this.children.length;\n\n    if (length > MAX_LAYERS_NUMBER) {\n      Util_1.Util.warn('The stage has ' + length + ' layers. Recommended maximin number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group.');\n    }\n\n    layer._setCanvasSize(this.width(), this.height());\n\n    layer.draw();\n\n    if (Global_1.Konva.isBrowser) {\n      this.content.appendChild(layer.canvas._canvas);\n    }\n\n    return this;\n  };\n\n  Stage.prototype.getParent = function () {\n    return null;\n  };\n\n  Stage.prototype.getLayer = function () {\n    return null;\n  };\n\n  Stage.prototype.getLayers = function () {\n    return this.getChildren();\n  };\n\n  Stage.prototype._bindContentEvents = function () {\n    if (!Global_1.Konva.isBrowser) {\n      return;\n    }\n\n    for (var n = 0; n < eventsLength; n++) {\n      addEvent(this, EVENTS[n]);\n    }\n  };\n\n  Stage.prototype._mouseenter = function (evt) {\n    this.setPointersPositions(evt);\n\n    this._fire(MOUSEENTER, {\n      evt: evt,\n      target: this,\n      currentTarget: this\n    });\n  };\n\n  Stage.prototype._mouseover = function (evt) {\n    this.setPointersPositions(evt);\n\n    this._fire(CONTENT_MOUSEOVER, {\n      evt: evt\n    });\n\n    this._fire(MOUSEOVER, {\n      evt: evt,\n      target: this,\n      currentTarget: this\n    });\n  };\n\n  Stage.prototype._mouseout = function (evt) {\n    this.setPointersPositions(evt);\n    var targetShape = this.targetShape;\n\n    if (targetShape && !DragAndDrop_1.DD.isDragging) {\n      targetShape._fireAndBubble(MOUSEOUT, {\n        evt: evt\n      });\n\n      targetShape._fireAndBubble(MOUSELEAVE, {\n        evt: evt\n      });\n\n      this.targetShape = null;\n    } else if (!DragAndDrop_1.DD.isDragging) {\n      this._fire(MOUSELEAVE, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n\n      this._fire(MOUSEOUT, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this.pointerPos = undefined;\n\n    this._fire(CONTENT_MOUSEOUT, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._mousemove = function (evt) {\n    if (Global_1.Konva.UA.ieMobile) {\n      return this._touchmove(evt);\n    }\n\n    this.setPointersPositions(evt);\n    var shape;\n\n    if (!DragAndDrop_1.DD.isDragging) {\n      shape = this.getIntersection(this.getPointerPosition());\n\n      if (shape && shape.isListening()) {\n        var differentTarget = !this.targetShape || this.targetShape !== shape;\n\n        if (!DragAndDrop_1.DD.isDragging && differentTarget) {\n          if (this.targetShape) {\n            this.targetShape._fireAndBubble(MOUSEOUT, {\n              evt: evt\n            }, shape);\n\n            this.targetShape._fireAndBubble(MOUSELEAVE, {\n              evt: evt\n            }, shape);\n          }\n\n          shape._fireAndBubble(MOUSEOVER, {\n            evt: evt\n          }, this.targetShape);\n\n          shape._fireAndBubble(MOUSEENTER, {\n            evt: evt\n          }, this.targetShape);\n\n          this.targetShape = shape;\n        } else {\n          shape._fireAndBubble(MOUSEMOVE, {\n            evt: evt\n          });\n        }\n      } else {\n        if (this.targetShape && !DragAndDrop_1.DD.isDragging) {\n          this.targetShape._fireAndBubble(MOUSEOUT, {\n            evt: evt\n          });\n\n          this.targetShape._fireAndBubble(MOUSELEAVE, {\n            evt: evt\n          });\n\n          this._fire(MOUSEOVER, {\n            evt: evt,\n            target: this,\n            currentTarget: this\n          });\n\n          this.targetShape = null;\n        }\n\n        this._fire(MOUSEMOVE, {\n          evt: evt,\n          target: this,\n          currentTarget: this\n        });\n      }\n\n      this._fire(CONTENT_MOUSEMOVE, {\n        evt: evt\n      });\n    }\n\n    if (evt.cancelable) {\n      evt.preventDefault();\n    }\n  };\n\n  Stage.prototype._mousedown = function (evt) {\n    if (Global_1.Konva.UA.ieMobile) {\n      return this._touchstart(evt);\n    }\n\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition());\n    Global_1.Konva.listenClickTap = true;\n\n    if (shape && shape.isListening()) {\n      this.clickStartShape = shape;\n\n      shape._fireAndBubble(MOUSEDOWN, {\n        evt: evt\n      });\n    } else {\n      this._fire(MOUSEDOWN, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this._fire(CONTENT_MOUSEDOWN, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._mouseup = function (evt) {\n    if (Global_1.Konva.UA.ieMobile) {\n      return this._touchend(evt);\n    }\n\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition()),\n        clickStartShape = this.clickStartShape,\n        clickEndShape = this.clickEndShape,\n        fireDblClick = false;\n\n    if (Global_1.Konva.inDblClickWindow) {\n      fireDblClick = true;\n      clearTimeout(this.dblTimeout);\n    } else if (!DragAndDrop_1.DD.justDragged) {\n      Global_1.Konva.inDblClickWindow = true;\n      clearTimeout(this.dblTimeout);\n    } else if (DragAndDrop_1.DD) {\n      DragAndDrop_1.DD.justDragged = false;\n    }\n\n    this.dblTimeout = setTimeout(function () {\n      Global_1.Konva.inDblClickWindow = false;\n    }, Global_1.Konva.dblClickWindow);\n\n    if (shape && shape.isListening()) {\n      this.clickEndShape = shape;\n\n      shape._fireAndBubble(MOUSEUP, {\n        evt: evt\n      });\n\n      if (Global_1.Konva.listenClickTap && clickStartShape && clickStartShape._id === shape._id) {\n        shape._fireAndBubble(CLICK, {\n          evt: evt\n        });\n\n        if (fireDblClick && clickEndShape && clickEndShape._id === shape._id) {\n          shape._fireAndBubble(DBL_CLICK, {\n            evt: evt\n          });\n        }\n      }\n    } else {\n      this._fire(MOUSEUP, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n\n      if (Global_1.Konva.listenClickTap) {\n        this._fire(CLICK, {\n          evt: evt,\n          target: this,\n          currentTarget: this\n        });\n      }\n\n      if (fireDblClick) {\n        this._fire(DBL_CLICK, {\n          evt: evt,\n          target: this,\n          currentTarget: this\n        });\n      }\n    }\n\n    this._fire(CONTENT_MOUSEUP, {\n      evt: evt\n    });\n\n    if (Global_1.Konva.listenClickTap) {\n      this._fire(CONTENT_CLICK, {\n        evt: evt\n      });\n\n      if (fireDblClick) {\n        this._fire(CONTENT_DBL_CLICK, {\n          evt: evt\n        });\n      }\n    }\n\n    Global_1.Konva.listenClickTap = false;\n\n    if (evt.cancelable) {\n      evt.preventDefault();\n    }\n  };\n\n  Stage.prototype._contextmenu = function (evt) {\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition());\n\n    if (shape && shape.isListening()) {\n      shape._fireAndBubble(CONTEXTMENU, {\n        evt: evt\n      });\n    } else {\n      this._fire(CONTEXTMENU, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this._fire(CONTENT_CONTEXTMENU, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._touchstart = function (evt) {\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition());\n    Global_1.Konva.listenClickTap = true;\n\n    if (shape && shape.isListening()) {\n      this.tapStartShape = shape;\n\n      shape._fireAndBubble(TOUCHSTART, {\n        evt: evt\n      });\n\n      if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n        evt.preventDefault();\n      }\n    } else {\n      this._fire(TOUCHSTART, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this._fire(CONTENT_TOUCHSTART, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._touchend = function (evt) {\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition()),\n        fireDblClick = false;\n\n    if (Global_1.Konva.inDblClickWindow) {\n      fireDblClick = true;\n      clearTimeout(this.dblTimeout);\n    } else {\n      Global_1.Konva.inDblClickWindow = true;\n      clearTimeout(this.dblTimeout);\n    }\n\n    this.dblTimeout = setTimeout(function () {\n      Global_1.Konva.inDblClickWindow = false;\n    }, Global_1.Konva.dblClickWindow);\n\n    if (shape && shape.isListening()) {\n      shape._fireAndBubble(TOUCHEND, {\n        evt: evt\n      });\n\n      if (Global_1.Konva.listenClickTap && this.tapStartShape && shape._id === this.tapStartShape._id) {\n        shape._fireAndBubble(TAP, {\n          evt: evt\n        });\n\n        if (fireDblClick) {\n          shape._fireAndBubble(DBL_TAP, {\n            evt: evt\n          });\n        }\n      }\n\n      if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n        evt.preventDefault();\n      }\n    } else {\n      this._fire(TOUCHEND, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n\n      if (Global_1.Konva.listenClickTap) {\n        this._fire(TAP, {\n          evt: evt,\n          target: this,\n          currentTarget: this\n        });\n      }\n\n      if (fireDblClick) {\n        this._fire(DBL_TAP, {\n          evt: evt,\n          target: this,\n          currentTarget: this\n        });\n      }\n    }\n\n    this._fire(CONTENT_TOUCHEND, {\n      evt: evt\n    });\n\n    if (Global_1.Konva.listenClickTap) {\n      this._fire(CONTENT_TAP, {\n        evt: evt\n      });\n\n      if (fireDblClick) {\n        this._fire(CONTENT_DBL_TAP, {\n          evt: evt\n        });\n      }\n    }\n\n    Global_1.Konva.listenClickTap = false;\n  };\n\n  Stage.prototype._touchmove = function (evt) {\n    this.setPointersPositions(evt);\n    var shape;\n\n    if (!DragAndDrop_1.DD.isDragging) {\n      shape = this.getIntersection(this.getPointerPosition());\n\n      if (shape && shape.isListening()) {\n        shape._fireAndBubble(TOUCHMOVE, {\n          evt: evt\n        });\n\n        if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n          evt.preventDefault();\n        }\n      } else {\n        this._fire(TOUCHMOVE, {\n          evt: evt,\n          target: this,\n          currentTarget: this\n        });\n      }\n\n      this._fire(CONTENT_TOUCHMOVE, {\n        evt: evt\n      });\n    }\n\n    if (DragAndDrop_1.DD.isDragging && DragAndDrop_1.DD.node.preventDefault() && evt.cancelable) {\n      evt.preventDefault();\n    }\n  };\n\n  Stage.prototype._wheel = function (evt) {\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition());\n\n    if (shape && shape.isListening()) {\n      shape._fireAndBubble(WHEEL, {\n        evt: evt\n      });\n    } else {\n      this._fire(WHEEL, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this._fire(CONTENT_WHEEL, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype.setPointersPositions = function (evt) {\n    var contentPosition = this._getContentPosition(),\n        x = null,\n        y = null;\n\n    evt = evt ? evt : window.event;\n\n    if (evt.touches !== undefined) {\n      if (evt.touches.length > 0) {\n        var touch = evt.touches[0];\n        x = touch.clientX - contentPosition.left;\n        y = touch.clientY - contentPosition.top;\n      }\n    } else {\n      x = evt.clientX - contentPosition.left;\n      y = evt.clientY - contentPosition.top;\n    }\n\n    if (x !== null && y !== null) {\n      this.pointerPos = {\n        x: x,\n        y: y\n      };\n    }\n  };\n\n  Stage.prototype._setPointerPosition = function (evt) {\n    Util_1.Util.warn('Method _setPointerPosition is deprecated. Use \"stage.setPointersPositions(event)\" instead.');\n    this.setPointersPositions(evt);\n  };\n\n  Stage.prototype._getContentPosition = function () {\n    var rect = this.content.getBoundingClientRect ? this.content.getBoundingClientRect() : {\n      top: 0,\n      left: 0\n    };\n    return {\n      top: rect.top,\n      left: rect.left\n    };\n  };\n\n  Stage.prototype._buildDOM = function () {\n    this.bufferCanvas = new Canvas_1.SceneCanvas();\n    this.bufferHitCanvas = new Canvas_1.HitCanvas({\n      pixelRatio: 1\n    });\n\n    if (!Global_1.Konva.isBrowser) {\n      return;\n    }\n\n    var container = this.container();\n\n    if (!container) {\n      throw 'Stage has no container. A container is required.';\n    }\n\n    container.innerHTML = EMPTY_STRING;\n    this.content = document.createElement('div');\n    this.content.style.position = RELATIVE;\n    this.content.style.userSelect = 'none';\n    this.content.className = KONVA_CONTENT;\n    this.content.setAttribute('role', 'presentation');\n    container.appendChild(this.content);\n\n    this._resizeDOM();\n  };\n\n  Stage.prototype.cache = function () {\n    Util_1.Util.warn('Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.');\n    return this;\n  };\n\n  Stage.prototype.clearCache = function () {\n    return this;\n  };\n\n  Stage.prototype.batchDraw = function () {\n    this.children.each(function (layer) {\n      layer.batchDraw();\n    });\n    return this;\n  };\n\n  return Stage;\n}(Container_1.Container);\n\nexports.Stage = Stage;\nStage.prototype.nodeType = STAGE;\n\nGlobal_2._registerNode(Stage);\n\nFactory_1.Factory.addGetterSetter(Stage, 'container');","map":{"version":3,"sources":["/home/daniel/reatret.net/react-app/node_modules/konva/lib/Stage.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","defineProperty","exports","value","Util_1","require","Factory_1","Container_1","Global_1","Canvas_1","DragAndDrop_1","Global_2","STAGE","STRING","PX","MOUSEOUT","MOUSELEAVE","MOUSEOVER","MOUSEENTER","MOUSEMOVE","MOUSEDOWN","MOUSEUP","CONTEXTMENU","CLICK","DBL_CLICK","TOUCHSTART","TOUCHEND","TAP","DBL_TAP","TOUCHMOVE","WHEEL","CONTENT_MOUSEOUT","CONTENT_MOUSEOVER","CONTENT_MOUSEMOVE","CONTENT_MOUSEDOWN","CONTENT_MOUSEUP","CONTENT_CONTEXTMENU","CONTENT_CLICK","CONTENT_DBL_CLICK","CONTENT_TOUCHSTART","CONTENT_TOUCHEND","CONTENT_DBL_TAP","CONTENT_TAP","CONTENT_TOUCHMOVE","CONTENT_WHEEL","RELATIVE","KONVA_CONTENT","SPACE","UNDERSCORE","CONTAINER","MAX_LAYERS_NUMBER","EMPTY_STRING","EVENTS","eventsLength","length","addEvent","ctx","eventName","content","addEventListener","evt","NO_POINTERS_MESSAGE","stages","checkNoClip","attrs","clipFunc","clipWidth","clipHeight","Util","warn","Stage","_super","config","_this","call","_buildDOM","_bindContentEvents","push","on","_resizeDOM","_checkVisibility","_validateAdd","child","isLayer","getType","isFastLayer","valid","throw","style","visible","display","setContainer","container","charAt","className","slice","document","getElementsByClassName","id","getElementById","_setAttr","parentElement","removeChild","appendChild","shouldDrawHit","clear","layers","children","len","n","clone","obj","createElement","Container","destroy","_isInDocument","index","indexOf","splice","getPointerPosition","pointerPos","getStage","getContent","_toKonvaCanvas","x","y","canvas","SceneCanvas","width","height","pixelRatio","_context","getContext","translate","each","layer","isVisible","layerCanvas","drawImage","_canvas","getWidth","getPixelRatio","getHeight","getIntersection","pos","selector","end","shape","getChildren","bufferCanvas","setSize","bufferHitCanvas","draw","add","arguments","i","_setCanvasSize","Konva","isBrowser","getParent","getLayer","getLayers","_mouseenter","setPointersPositions","_fire","target","currentTarget","_mouseover","_mouseout","targetShape","DD","isDragging","_fireAndBubble","undefined","_mousemove","UA","ieMobile","_touchmove","isListening","differentTarget","cancelable","preventDefault","_mousedown","_touchstart","listenClickTap","clickStartShape","_mouseup","_touchend","clickEndShape","fireDblClick","inDblClickWindow","clearTimeout","dblTimeout","justDragged","setTimeout","dblClickWindow","_id","_contextmenu","tapStartShape","node","_wheel","contentPosition","_getContentPosition","window","event","touches","touch","clientX","left","clientY","top","_setPointerPosition","rect","getBoundingClientRect","HitCanvas","innerHTML","position","userSelect","setAttribute","cache","clearCache","batchDraw","nodeType","_registerNode","Factory","addGetterSetter"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar Util_1 = require(\"./Util\");\nvar Factory_1 = require(\"./Factory\");\nvar Container_1 = require(\"./Container\");\nvar Global_1 = require(\"./Global\");\nvar Canvas_1 = require(\"./Canvas\");\nvar DragAndDrop_1 = require(\"./DragAndDrop\");\nvar Global_2 = require(\"./Global\");\nvar STAGE = 'Stage', STRING = 'string', PX = 'px', MOUSEOUT = 'mouseout', MOUSELEAVE = 'mouseleave', MOUSEOVER = 'mouseover', MOUSEENTER = 'mouseenter', MOUSEMOVE = 'mousemove', MOUSEDOWN = 'mousedown', MOUSEUP = 'mouseup', CONTEXTMENU = 'contextmenu', CLICK = 'click', DBL_CLICK = 'dblclick', TOUCHSTART = 'touchstart', TOUCHEND = 'touchend', TAP = 'tap', DBL_TAP = 'dbltap', TOUCHMOVE = 'touchmove', WHEEL = 'wheel', CONTENT_MOUSEOUT = 'contentMouseout', CONTENT_MOUSEOVER = 'contentMouseover', CONTENT_MOUSEMOVE = 'contentMousemove', CONTENT_MOUSEDOWN = 'contentMousedown', CONTENT_MOUSEUP = 'contentMouseup', CONTENT_CONTEXTMENU = 'contentContextmenu', CONTENT_CLICK = 'contentClick', CONTENT_DBL_CLICK = 'contentDblclick', CONTENT_TOUCHSTART = 'contentTouchstart', CONTENT_TOUCHEND = 'contentTouchend', CONTENT_DBL_TAP = 'contentDbltap', CONTENT_TAP = 'contentTap', CONTENT_TOUCHMOVE = 'contentTouchmove', CONTENT_WHEEL = 'contentWheel', RELATIVE = 'relative', KONVA_CONTENT = 'konvajs-content', SPACE = ' ', UNDERSCORE = '_', CONTAINER = 'container', MAX_LAYERS_NUMBER = 5, EMPTY_STRING = '', EVENTS = [\n    MOUSEENTER,\n    MOUSEDOWN,\n    MOUSEMOVE,\n    MOUSEUP,\n    MOUSEOUT,\n    TOUCHSTART,\n    TOUCHMOVE,\n    TOUCHEND,\n    MOUSEOVER,\n    WHEEL,\n    CONTEXTMENU\n], eventsLength = EVENTS.length;\nfunction addEvent(ctx, eventName) {\n    ctx.content.addEventListener(eventName, function (evt) {\n        ctx[UNDERSCORE + eventName](evt);\n    }, false);\n}\nvar NO_POINTERS_MESSAGE = \"Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);\";\nexports.stages = [];\nfunction checkNoClip(attrs) {\n    if (attrs === void 0) { attrs = {}; }\n    if (attrs.clipFunc || attrs.clipWidth || attrs.clipHeight) {\n        Util_1.Util.warn('Stage does not support clipping. Please use clip for Layers or Groups.');\n    }\n    return attrs;\n}\nvar Stage = (function (_super) {\n    __extends(Stage, _super);\n    function Stage(config) {\n        var _this = _super.call(this, checkNoClip(config)) || this;\n        _this._buildDOM();\n        _this._bindContentEvents();\n        exports.stages.push(_this);\n        _this.on('widthChange.konva heightChange.konva', _this._resizeDOM);\n        _this.on('visibleChange.konva', _this._checkVisibility);\n        _this.on('clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva', function () {\n            checkNoClip(_this.attrs);\n        });\n        _this._checkVisibility();\n        return _this;\n    }\n    Stage.prototype._validateAdd = function (child) {\n        var isLayer = child.getType() === 'Layer';\n        var isFastLayer = child.getType() === 'FastLayer';\n        var valid = isLayer || isFastLayer;\n        if (!valid) {\n            Util_1.Util.throw('You may only add layers to the stage.');\n        }\n    };\n    Stage.prototype._checkVisibility = function () {\n        var style = this.visible() ? '' : 'none';\n        this.content.style.display = style;\n    };\n    Stage.prototype.setContainer = function (container) {\n        if (typeof container === STRING) {\n            if (container.charAt(0) === '.') {\n                var className = container.slice(1);\n                container = document.getElementsByClassName(className)[0];\n            }\n            else {\n                var id;\n                if (container.charAt(0) !== '#') {\n                    id = container;\n                }\n                else {\n                    id = container.slice(1);\n                }\n                container = document.getElementById(id);\n            }\n            if (!container) {\n                throw 'Can not find container in document with id ' + id;\n            }\n        }\n        this._setAttr(CONTAINER, container);\n        if (this.content) {\n            this.content.parentElement.removeChild(this.content);\n            container.appendChild(this.content);\n        }\n        return this;\n    };\n    Stage.prototype.shouldDrawHit = function () {\n        return true;\n    };\n    Stage.prototype.clear = function () {\n        var layers = this.children, len = layers.length, n;\n        for (n = 0; n < len; n++) {\n            layers[n].clear();\n        }\n        return this;\n    };\n    Stage.prototype.clone = function (obj) {\n        if (!obj) {\n            obj = {};\n        }\n        obj.container = document.createElement('div');\n        return Container_1.Container.prototype.clone.call(this, obj);\n    };\n    Stage.prototype.destroy = function () {\n        _super.prototype.destroy.call(this);\n        var content = this.content;\n        if (content && Util_1.Util._isInDocument(content)) {\n            this.container().removeChild(content);\n        }\n        var index = exports.stages.indexOf(this);\n        if (index > -1) {\n            exports.stages.splice(index, 1);\n        }\n        return this;\n    };\n    Stage.prototype.getPointerPosition = function () {\n        if (!this.pointerPos) {\n            Util_1.Util.warn(NO_POINTERS_MESSAGE);\n        }\n        return this.pointerPos;\n    };\n    Stage.prototype.getStage = function () {\n        return this;\n    };\n    Stage.prototype.getContent = function () {\n        return this.content;\n    };\n    Stage.prototype._toKonvaCanvas = function (config) {\n        config = config || {};\n        var x = config.x || 0, y = config.y || 0, canvas = new Canvas_1.SceneCanvas({\n            width: config.width || this.width(),\n            height: config.height || this.height(),\n            pixelRatio: config.pixelRatio || 1\n        }), _context = canvas.getContext()._context, layers = this.children;\n        if (x || y) {\n            _context.translate(-1 * x, -1 * y);\n        }\n        layers.each(function (layer) {\n            if (!layer.isVisible()) {\n                return;\n            }\n            var layerCanvas = layer._toKonvaCanvas(config);\n            _context.drawImage(layerCanvas._canvas, x, y, layerCanvas.getWidth() / layerCanvas.getPixelRatio(), layerCanvas.getHeight() / layerCanvas.getPixelRatio());\n        });\n        return canvas;\n    };\n    Stage.prototype.getIntersection = function (pos, selector) {\n        var layers = this.children, len = layers.length, end = len - 1, n, shape;\n        for (n = end; n >= 0; n--) {\n            shape = layers[n].getIntersection(pos, selector);\n            if (shape) {\n                return shape;\n            }\n        }\n        return null;\n    };\n    Stage.prototype._resizeDOM = function () {\n        if (this.content) {\n            var width = this.width(), height = this.height(), layers = this.getChildren(), len = layers.length, n, layer;\n            this.content.style.width = width + PX;\n            this.content.style.height = height + PX;\n            this.bufferCanvas.setSize(width, height);\n            this.bufferHitCanvas.setSize(width, height);\n            for (n = 0; n < len; n++) {\n                layer = layers[n];\n                layer.setSize({ width: width, height: height });\n                layer.draw();\n            }\n        }\n    };\n    Stage.prototype.add = function (layer) {\n        if (arguments.length > 1) {\n            for (var i = 0; i < arguments.length; i++) {\n                this.add(arguments[i]);\n            }\n            return this;\n        }\n        _super.prototype.add.call(this, layer);\n        var length = this.children.length;\n        if (length > MAX_LAYERS_NUMBER) {\n            Util_1.Util.warn('The stage has ' +\n                length +\n                ' layers. Recommended maximin number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group.');\n        }\n        layer._setCanvasSize(this.width(), this.height());\n        layer.draw();\n        if (Global_1.Konva.isBrowser) {\n            this.content.appendChild(layer.canvas._canvas);\n        }\n        return this;\n    };\n    Stage.prototype.getParent = function () {\n        return null;\n    };\n    Stage.prototype.getLayer = function () {\n        return null;\n    };\n    Stage.prototype.getLayers = function () {\n        return this.getChildren();\n    };\n    Stage.prototype._bindContentEvents = function () {\n        if (!Global_1.Konva.isBrowser) {\n            return;\n        }\n        for (var n = 0; n < eventsLength; n++) {\n            addEvent(this, EVENTS[n]);\n        }\n    };\n    Stage.prototype._mouseenter = function (evt) {\n        this.setPointersPositions(evt);\n        this._fire(MOUSEENTER, { evt: evt, target: this, currentTarget: this });\n    };\n    Stage.prototype._mouseover = function (evt) {\n        this.setPointersPositions(evt);\n        this._fire(CONTENT_MOUSEOVER, { evt: evt });\n        this._fire(MOUSEOVER, { evt: evt, target: this, currentTarget: this });\n    };\n    Stage.prototype._mouseout = function (evt) {\n        this.setPointersPositions(evt);\n        var targetShape = this.targetShape;\n        if (targetShape && !DragAndDrop_1.DD.isDragging) {\n            targetShape._fireAndBubble(MOUSEOUT, { evt: evt });\n            targetShape._fireAndBubble(MOUSELEAVE, { evt: evt });\n            this.targetShape = null;\n        }\n        else if (!DragAndDrop_1.DD.isDragging) {\n            this._fire(MOUSELEAVE, {\n                evt: evt,\n                target: this,\n                currentTarget: this\n            });\n            this._fire(MOUSEOUT, {\n                evt: evt,\n                target: this,\n                currentTarget: this\n            });\n        }\n        this.pointerPos = undefined;\n        this._fire(CONTENT_MOUSEOUT, { evt: evt });\n    };\n    Stage.prototype._mousemove = function (evt) {\n        if (Global_1.Konva.UA.ieMobile) {\n            return this._touchmove(evt);\n        }\n        this.setPointersPositions(evt);\n        var shape;\n        if (!DragAndDrop_1.DD.isDragging) {\n            shape = this.getIntersection(this.getPointerPosition());\n            if (shape && shape.isListening()) {\n                var differentTarget = !this.targetShape || this.targetShape !== shape;\n                if (!DragAndDrop_1.DD.isDragging && differentTarget) {\n                    if (this.targetShape) {\n                        this.targetShape._fireAndBubble(MOUSEOUT, { evt: evt }, shape);\n                        this.targetShape._fireAndBubble(MOUSELEAVE, { evt: evt }, shape);\n                    }\n                    shape._fireAndBubble(MOUSEOVER, { evt: evt }, this.targetShape);\n                    shape._fireAndBubble(MOUSEENTER, { evt: evt }, this.targetShape);\n                    this.targetShape = shape;\n                }\n                else {\n                    shape._fireAndBubble(MOUSEMOVE, { evt: evt });\n                }\n            }\n            else {\n                if (this.targetShape && !DragAndDrop_1.DD.isDragging) {\n                    this.targetShape._fireAndBubble(MOUSEOUT, { evt: evt });\n                    this.targetShape._fireAndBubble(MOUSELEAVE, { evt: evt });\n                    this._fire(MOUSEOVER, {\n                        evt: evt,\n                        target: this,\n                        currentTarget: this\n                    });\n                    this.targetShape = null;\n                }\n                this._fire(MOUSEMOVE, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this\n                });\n            }\n            this._fire(CONTENT_MOUSEMOVE, { evt: evt });\n        }\n        if (evt.cancelable) {\n            evt.preventDefault();\n        }\n    };\n    Stage.prototype._mousedown = function (evt) {\n        if (Global_1.Konva.UA.ieMobile) {\n            return this._touchstart(evt);\n        }\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition());\n        Global_1.Konva.listenClickTap = true;\n        if (shape && shape.isListening()) {\n            this.clickStartShape = shape;\n            shape._fireAndBubble(MOUSEDOWN, { evt: evt });\n        }\n        else {\n            this._fire(MOUSEDOWN, {\n                evt: evt,\n                target: this,\n                currentTarget: this\n            });\n        }\n        this._fire(CONTENT_MOUSEDOWN, { evt: evt });\n    };\n    Stage.prototype._mouseup = function (evt) {\n        if (Global_1.Konva.UA.ieMobile) {\n            return this._touchend(evt);\n        }\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition()), clickStartShape = this.clickStartShape, clickEndShape = this.clickEndShape, fireDblClick = false;\n        if (Global_1.Konva.inDblClickWindow) {\n            fireDblClick = true;\n            clearTimeout(this.dblTimeout);\n        }\n        else if (!DragAndDrop_1.DD.justDragged) {\n            Global_1.Konva.inDblClickWindow = true;\n            clearTimeout(this.dblTimeout);\n        }\n        else if (DragAndDrop_1.DD) {\n            DragAndDrop_1.DD.justDragged = false;\n        }\n        this.dblTimeout = setTimeout(function () {\n            Global_1.Konva.inDblClickWindow = false;\n        }, Global_1.Konva.dblClickWindow);\n        if (shape && shape.isListening()) {\n            this.clickEndShape = shape;\n            shape._fireAndBubble(MOUSEUP, { evt: evt });\n            if (Global_1.Konva.listenClickTap &&\n                clickStartShape &&\n                clickStartShape._id === shape._id) {\n                shape._fireAndBubble(CLICK, { evt: evt });\n                if (fireDblClick && clickEndShape && clickEndShape._id === shape._id) {\n                    shape._fireAndBubble(DBL_CLICK, { evt: evt });\n                }\n            }\n        }\n        else {\n            this._fire(MOUSEUP, { evt: evt, target: this, currentTarget: this });\n            if (Global_1.Konva.listenClickTap) {\n                this._fire(CLICK, { evt: evt, target: this, currentTarget: this });\n            }\n            if (fireDblClick) {\n                this._fire(DBL_CLICK, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this\n                });\n            }\n        }\n        this._fire(CONTENT_MOUSEUP, { evt: evt });\n        if (Global_1.Konva.listenClickTap) {\n            this._fire(CONTENT_CLICK, { evt: evt });\n            if (fireDblClick) {\n                this._fire(CONTENT_DBL_CLICK, { evt: evt });\n            }\n        }\n        Global_1.Konva.listenClickTap = false;\n        if (evt.cancelable) {\n            evt.preventDefault();\n        }\n    };\n    Stage.prototype._contextmenu = function (evt) {\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition());\n        if (shape && shape.isListening()) {\n            shape._fireAndBubble(CONTEXTMENU, { evt: evt });\n        }\n        else {\n            this._fire(CONTEXTMENU, {\n                evt: evt,\n                target: this,\n                currentTarget: this\n            });\n        }\n        this._fire(CONTENT_CONTEXTMENU, { evt: evt });\n    };\n    Stage.prototype._touchstart = function (evt) {\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition());\n        Global_1.Konva.listenClickTap = true;\n        if (shape && shape.isListening()) {\n            this.tapStartShape = shape;\n            shape._fireAndBubble(TOUCHSTART, { evt: evt });\n            if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n                evt.preventDefault();\n            }\n        }\n        else {\n            this._fire(TOUCHSTART, {\n                evt: evt,\n                target: this,\n                currentTarget: this\n            });\n        }\n        this._fire(CONTENT_TOUCHSTART, { evt: evt });\n    };\n    Stage.prototype._touchend = function (evt) {\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition()), fireDblClick = false;\n        if (Global_1.Konva.inDblClickWindow) {\n            fireDblClick = true;\n            clearTimeout(this.dblTimeout);\n        }\n        else {\n            Global_1.Konva.inDblClickWindow = true;\n            clearTimeout(this.dblTimeout);\n        }\n        this.dblTimeout = setTimeout(function () {\n            Global_1.Konva.inDblClickWindow = false;\n        }, Global_1.Konva.dblClickWindow);\n        if (shape && shape.isListening()) {\n            shape._fireAndBubble(TOUCHEND, { evt: evt });\n            if (Global_1.Konva.listenClickTap &&\n                this.tapStartShape &&\n                shape._id === this.tapStartShape._id) {\n                shape._fireAndBubble(TAP, { evt: evt });\n                if (fireDblClick) {\n                    shape._fireAndBubble(DBL_TAP, { evt: evt });\n                }\n            }\n            if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n                evt.preventDefault();\n            }\n        }\n        else {\n            this._fire(TOUCHEND, { evt: evt, target: this, currentTarget: this });\n            if (Global_1.Konva.listenClickTap) {\n                this._fire(TAP, { evt: evt, target: this, currentTarget: this });\n            }\n            if (fireDblClick) {\n                this._fire(DBL_TAP, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this\n                });\n            }\n        }\n        this._fire(CONTENT_TOUCHEND, { evt: evt });\n        if (Global_1.Konva.listenClickTap) {\n            this._fire(CONTENT_TAP, { evt: evt });\n            if (fireDblClick) {\n                this._fire(CONTENT_DBL_TAP, { evt: evt });\n            }\n        }\n        Global_1.Konva.listenClickTap = false;\n    };\n    Stage.prototype._touchmove = function (evt) {\n        this.setPointersPositions(evt);\n        var shape;\n        if (!DragAndDrop_1.DD.isDragging) {\n            shape = this.getIntersection(this.getPointerPosition());\n            if (shape && shape.isListening()) {\n                shape._fireAndBubble(TOUCHMOVE, { evt: evt });\n                if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n                    evt.preventDefault();\n                }\n            }\n            else {\n                this._fire(TOUCHMOVE, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this\n                });\n            }\n            this._fire(CONTENT_TOUCHMOVE, { evt: evt });\n        }\n        if (DragAndDrop_1.DD.isDragging && DragAndDrop_1.DD.node.preventDefault() && evt.cancelable) {\n            evt.preventDefault();\n        }\n    };\n    Stage.prototype._wheel = function (evt) {\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition());\n        if (shape && shape.isListening()) {\n            shape._fireAndBubble(WHEEL, { evt: evt });\n        }\n        else {\n            this._fire(WHEEL, {\n                evt: evt,\n                target: this,\n                currentTarget: this\n            });\n        }\n        this._fire(CONTENT_WHEEL, { evt: evt });\n    };\n    Stage.prototype.setPointersPositions = function (evt) {\n        var contentPosition = this._getContentPosition(), x = null, y = null;\n        evt = evt ? evt : window.event;\n        if (evt.touches !== undefined) {\n            if (evt.touches.length > 0) {\n                var touch = evt.touches[0];\n                x = touch.clientX - contentPosition.left;\n                y = touch.clientY - contentPosition.top;\n            }\n        }\n        else {\n            x = evt.clientX - contentPosition.left;\n            y = evt.clientY - contentPosition.top;\n        }\n        if (x !== null && y !== null) {\n            this.pointerPos = {\n                x: x,\n                y: y\n            };\n        }\n    };\n    Stage.prototype._setPointerPosition = function (evt) {\n        Util_1.Util.warn('Method _setPointerPosition is deprecated. Use \"stage.setPointersPositions(event)\" instead.');\n        this.setPointersPositions(evt);\n    };\n    Stage.prototype._getContentPosition = function () {\n        var rect = this.content.getBoundingClientRect\n            ? this.content.getBoundingClientRect()\n            : { top: 0, left: 0 };\n        return {\n            top: rect.top,\n            left: rect.left\n        };\n    };\n    Stage.prototype._buildDOM = function () {\n        this.bufferCanvas = new Canvas_1.SceneCanvas();\n        this.bufferHitCanvas = new Canvas_1.HitCanvas({ pixelRatio: 1 });\n        if (!Global_1.Konva.isBrowser) {\n            return;\n        }\n        var container = this.container();\n        if (!container) {\n            throw 'Stage has no container. A container is required.';\n        }\n        container.innerHTML = EMPTY_STRING;\n        this.content = document.createElement('div');\n        this.content.style.position = RELATIVE;\n        this.content.style.userSelect = 'none';\n        this.content.className = KONVA_CONTENT;\n        this.content.setAttribute('role', 'presentation');\n        container.appendChild(this.content);\n        this._resizeDOM();\n    };\n    Stage.prototype.cache = function () {\n        Util_1.Util.warn('Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.');\n        return this;\n    };\n    Stage.prototype.clearCache = function () {\n        return this;\n    };\n    Stage.prototype.batchDraw = function () {\n        this.children.each(function (layer) {\n            layer.batchDraw();\n        });\n        return this;\n    };\n    return Stage;\n}(Container_1.Container));\nexports.Stage = Stage;\nStage.prototype.nodeType = STAGE;\nGlobal_2._registerNode(Stage);\nFactory_1.Factory.addGetterSetter(Stage, 'container');\n"]},"metadata":{},"sourceType":"script"}